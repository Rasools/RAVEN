<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of randomSampling</title>
  <meta name="keywords" content="randomSampling">
  <meta name="description" content="randomSampling">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">core</a> &gt; randomSampling.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for core&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>randomSampling
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>randomSampling</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [solutions, goodRxns]=randomSampling(model, nSamples, replaceBoundsWithInf,supressErrors,showProgress,goodRxns) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> randomSampling
   Returns a number of random solutions

   model                   a model structure
   nSamples                the number of solutions to return
                           (opt, default 1000)
   replaceBoundsWithInf    replace the largest upper bounds with Inf and
                           the smallest lower bounds with -Inf. This is
                           needed in order to get solutions without loops
                           if your model has for example 1000/-1000 as
                           arbitary large bounds. If your model only has
                           &quot;biologically relevant&quot; bounds, then set this
                           to false (opt, default true)
   supressErrors           the program will halt if it has problems
                           finding non-zero solutions which are not
                           involved in loops. This could be because the
                           constraints on the model are too relaxed (such
                           as unlimited glucose uptake) or too strict
                           (such as too many and too narrow constraints)
                           (opt, default false)
   showProgress            if true, it will display in the command window 
                           how many iterations have been done (opt, default
                           false)
   goodRxns                double vector of indexes of those reactions
                           that are not involved in loops and can be used
                           as random objective functions, as generated by
                           a previous run of randomSampling on the same
                           model (opt, default empty)

   solutions               matrix with the solutions
   goodRxns                double vector of indexes of those reactions
                           that are not involved in loops and can be used
                           as random objective functions

   The solutions are generated by maximizing (with random weights) for a
   random set of three reactions. For reversible reactions it randomly
   chooses between maximizing and minimizing.

   Usage: solutions=randomSampling(model, nSamples, replaceBoundsWithInf)

   Eduard Kerkhoven, 2018-02-28
   Benjamin Sanchez, 2018-04-10</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>	dispEM</li><li><a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params, var)">setParam</a>	setParam</li><li><a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, constrainReversible, reservedRxns, suppressWarnings)">simplifyModel</a>	simplifyModel</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function I=randsample(n,k,replacement)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [solutions, goodRxns]=randomSampling(model, nSamples, replaceBoundsWithInf,supressErrors,showProgress,goodRxns)</a>
0002 <span class="comment">% randomSampling</span>
0003 <span class="comment">%   Returns a number of random solutions</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   model                   a model structure</span>
0006 <span class="comment">%   nSamples                the number of solutions to return</span>
0007 <span class="comment">%                           (opt, default 1000)</span>
0008 <span class="comment">%   replaceBoundsWithInf    replace the largest upper bounds with Inf and</span>
0009 <span class="comment">%                           the smallest lower bounds with -Inf. This is</span>
0010 <span class="comment">%                           needed in order to get solutions without loops</span>
0011 <span class="comment">%                           if your model has for example 1000/-1000 as</span>
0012 <span class="comment">%                           arbitary large bounds. If your model only has</span>
0013 <span class="comment">%                           &quot;biologically relevant&quot; bounds, then set this</span>
0014 <span class="comment">%                           to false (opt, default true)</span>
0015 <span class="comment">%   supressErrors           the program will halt if it has problems</span>
0016 <span class="comment">%                           finding non-zero solutions which are not</span>
0017 <span class="comment">%                           involved in loops. This could be because the</span>
0018 <span class="comment">%                           constraints on the model are too relaxed (such</span>
0019 <span class="comment">%                           as unlimited glucose uptake) or too strict</span>
0020 <span class="comment">%                           (such as too many and too narrow constraints)</span>
0021 <span class="comment">%                           (opt, default false)</span>
0022 <span class="comment">%   showProgress            if true, it will display in the command window</span>
0023 <span class="comment">%                           how many iterations have been done (opt, default</span>
0024 <span class="comment">%                           false)</span>
0025 <span class="comment">%   goodRxns                double vector of indexes of those reactions</span>
0026 <span class="comment">%                           that are not involved in loops and can be used</span>
0027 <span class="comment">%                           as random objective functions, as generated by</span>
0028 <span class="comment">%                           a previous run of randomSampling on the same</span>
0029 <span class="comment">%                           model (opt, default empty)</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%   solutions               matrix with the solutions</span>
0032 <span class="comment">%   goodRxns                double vector of indexes of those reactions</span>
0033 <span class="comment">%                           that are not involved in loops and can be used</span>
0034 <span class="comment">%                           as random objective functions</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%   The solutions are generated by maximizing (with random weights) for a</span>
0037 <span class="comment">%   random set of three reactions. For reversible reactions it randomly</span>
0038 <span class="comment">%   chooses between maximizing and minimizing.</span>
0039 <span class="comment">%</span>
0040 <span class="comment">%   Usage: solutions=randomSampling(model, nSamples, replaceBoundsWithInf)</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%   Eduard Kerkhoven, 2018-02-28</span>
0043 <span class="comment">%   Benjamin Sanchez, 2018-04-10</span>
0044 <span class="comment">%</span>
0045 
0046 <span class="keyword">if</span> nargin&lt;2
0047     nSamples=1000;
0048 <span class="keyword">end</span>
0049 <span class="keyword">if</span> nargin&lt;3
0050     replaceBoundsWithInf=true;
0051 <span class="keyword">end</span>
0052 <span class="keyword">if</span> nargin&lt;4
0053     supressErrors=false;
0054 <span class="keyword">end</span>
0055 <span class="keyword">if</span> nargin&lt;5
0056     showProgress=false;
0057 <span class="keyword">end</span>
0058 
0059 nRxns=2; <span class="comment">%Number of reactions in the objective function in each iteration</span>
0060 
0061 <span class="comment">%First check that the model is feasible given the constraints</span>
0062 sol=solveLP(model);
0063 <span class="keyword">if</span> isempty(sol.x)
0064     EM=<span class="string">'The model has no feasible solution'</span>;
0065     <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(EM);
0066 <span class="keyword">end</span>
0067 
0068 <span class="comment">%Simplify the model to speed stuff up a little. Keep original mapping</span>
0069 originalRxns=model.rxns;
0070 model=<a href="simplifyModel.html" class="code" title="function [reducedModel, deletedReactions, deletedMetabolites]=simplifyModel(model,deleteUnconstrained, deleteDuplicates, deleteZeroInterval, deleteInaccessible, deleteMinMax, groupLinear, constrainReversible, reservedRxns, suppressWarnings)">simplifyModel</a>(model,false,false,true,true);
0071 
0072 <span class="comment">%Then change the bounds to +/- Inf. This is needed in order to not have</span>
0073 <span class="comment">%loops in the solutions</span>
0074 <span class="keyword">if</span> replaceBoundsWithInf==true
0075     model.ub(model.ub==max(model.ub))=Inf;
0076     <span class="keyword">if</span> min(model.lb)&lt;0 <span class="comment">% Only negative lower bounds should be set to -Inf</span>
0077         model.lb(model.lb==min(model.lb))=-Inf;
0078     <span class="keyword">end</span>
0079 <span class="keyword">end</span>
0080 
0081 <span class="comment">%Reactions which can be involved in loops should not be optimized for.</span>
0082 <span class="comment">%Check which reactions reach an arbitary high upper bound</span>
0083 <span class="keyword">if</span> nargin&lt;6
0084     goodRxns=true(numel(model.rxns),1);
0085     <span class="keyword">for</span> i=1:numel(model.rxns)
0086         <span class="keyword">if</span> showProgress &amp;&amp; rem(i,100) == 0
0087             disp([<span class="string">'Preparing random sampling: ready with '</span> num2str(i) <span class="string">'/'</span> num2str(numel(model.rxns)) <span class="string">' rxns'</span>])
0088         <span class="keyword">end</span>
0089         <span class="keyword">if</span> goodRxns(i)==true
0090             testModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params, var)">setParam</a>(model,<span class="string">'eq'</span>,model.rxns(i),1000);
0091             sol=solveLP(testModel);
0092             <span class="keyword">if</span> ~isempty(sol.f)
0093                 goodRxns(abs(sol.x)&gt;999)=false;
0094             <span class="keyword">else</span>
0095                 <span class="comment">%If the reaction is reversible, also check in that direction</span>
0096                 <span class="keyword">if</span> model.rev(i)
0097                     testModel=<a href="setParam.html" class="code" title="function model=setParam(model, paramType, rxnList, params, var)">setParam</a>(model,<span class="string">'eq'</span>,model.rxns(i),-1000);
0098                     sol=solveLP(testModel);
0099                     <span class="keyword">if</span> ~isempty(sol.f)
0100                         goodRxns(abs(sol.x)&gt;999)=false;
0101                     <span class="keyword">end</span>
0102                 <span class="keyword">end</span>
0103             <span class="keyword">end</span>
0104         <span class="keyword">end</span>
0105     <span class="keyword">end</span>
0106     goodRxns=find(goodRxns);
0107 <span class="keyword">end</span>
0108 
0109 <span class="comment">%Reserve space for a solution matrix</span>
0110 sols=zeros(numel(model.rxns),nSamples);
0111 
0112 <span class="comment">%Main loop</span>
0113 counter=1;
0114 badSolutions=0;
0115 <span class="keyword">while</span> counter&lt;=nSamples
0116     <span class="keyword">if</span> showProgress &amp;&amp; rem(counter,100) == 0
0117         disp([<span class="string">'Performing random sampling: ready with '</span> num2str(counter) <span class="string">'/'</span> num2str(nSamples) <span class="string">' iterations'</span>])
0118     <span class="keyword">end</span>
0119     rxns=<a href="#_sub1" class="code" title="subfunction I=randsample(n,k,replacement)">randsample</a>(numel(goodRxns),nRxns);
0120     model.c=zeros(numel(model.rxns),1);
0121     multipliers=<a href="#_sub1" class="code" title="subfunction I=randsample(n,k,replacement)">randsample</a>([-1 1],nRxns,true);
0122     multipliers(model.rev(goodRxns(rxns))==0)=1;
0123     model.c(goodRxns(rxns))=rand(nRxns,1).*multipliers;
0124     sol=solveLP(model);
0125     <span class="keyword">if</span> any(sol.x)
0126         <span class="keyword">if</span> abs(sol.f)&gt;10^-8
0127             sols(:,counter)=sol.x;
0128             counter=counter+1;
0129             badSolutions=0;
0130         <span class="keyword">else</span>
0131             badSolutions=badSolutions+1;
0132             <span class="comment">%If it only finds bad solutions then throw an error.</span>
0133             <span class="keyword">if</span> badSolutions==50 &amp;&amp; supressErrors==false
0134                 EM=<span class="string">'The program is having problems finding non-zero solutions that are not involved in loops. Review the constraints on your model. Set supressErrors to true to ignore this error'</span>;
0135                 <a href="dispEM.html" class="code" title="function dispEM(string,throwErrors,toList,trimWarnings)">dispEM</a>(EM);
0136             <span class="keyword">end</span>
0137         <span class="keyword">end</span>
0138     <span class="keyword">end</span>
0139 <span class="keyword">end</span>
0140 
0141 <span class="comment">%Map to original model</span>
0142 [~, I]=ismember(model.rxns,originalRxns);
0143 solutions=zeros(numel(originalRxns),nSamples);
0144 solutions(I,:)=sols;
0145 solutions=sparse(solutions);
0146 <span class="keyword">end</span>
0147 
0148 <span class="comment">%To use instead of the normal Matlab randsample function. This is in order</span>
0149 <span class="comment">%to not depend on the Matlab statistical toolbox.</span>
0150 <a name="_sub1" href="#_subfunctions" class="code">function I=randsample(n,k,replacement)</a>
0151 <span class="keyword">if</span> nargin&lt;3
0152     replacement=false;
0153 <span class="keyword">end</span>
0154 <span class="comment">%n can be a integer, which leads to I being sampled from 1:n, or it can be</span>
0155 <span class="comment">%a population to sample from.</span>
0156 <span class="keyword">if</span> numel(n)==1 &amp;&amp; isnumeric(n)
0157     n=1:n;
0158 <span class="keyword">end</span>
0159 <span class="comment">%Loop and get random numbers until the list is unique. This is only a good</span>
0160 <span class="comment">%option is the number of samples is small compared to the population. There</span>
0161 <span class="comment">%are several checks that should be made here, for example regarding size</span>
0162 <span class="comment">%and that the number of samples is &lt;=population size if replacement==false.</span>
0163 <span class="comment">%This is not the case in randomSampling, so such checks are ignored</span>
0164 <span class="keyword">while</span> true
0165     J=randi(numel(n),[k,1]);
0166     <span class="keyword">if</span> replacement==true || numel(J)==numel(unique(J))
0167         I=n(J);
0168         <span class="keyword">break</span>;
0169     <span class="keyword">end</span>
0170 <span class="keyword">end</span>
0171 I=I(:);
0172 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Wed 03-Jun-2020 13:07:00 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>